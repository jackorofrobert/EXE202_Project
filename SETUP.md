# EmoCare - Complete Setup Guide

H∆∞·ªõng d·∫´n c√†i ƒë·∫∑t ƒë·∫ßy ƒë·ªß cho ·ª©ng d·ª•ng EmoCare v·ªõi t·∫•t c·∫£ c√°c d·ªãch v·ª• c·∫ßn thi·∫øt.

## üìã M·ª•c l·ª•c

1. [Environment Variables](#environment-variables)
2. [Firebase Setup](#firebase-setup)
3. [Firestore Database](#firestore-database)
4. [Cloudinary Setup](#cloudinary-setup)
5. [Gemini AI Setup](#gemini-ai-setup)
6. [Firestore Indexes](#firestore-indexes)
7. [Testing](#testing)

---

## üîß Environment Variables

T·∫°o file `.env` trong th∆∞ m·ª•c root v·ªõi c√°c bi·∫øn sau:

```env
# Firebase Configuration
REACT_APP_FIREBASE_API_KEY=your_firebase_api_key
REACT_APP_FIREBASE_AUTH_DOMAIN=your_project.firebaseapp.com
REACT_APP_FIREBASE_PROJECT_ID=your_project_id
REACT_APP_FIREBASE_STORAGE_BUCKET=your_project.appspot.com
REACT_APP_FIREBASE_MESSAGING_SENDER_ID=your_sender_id
REACT_APP_FIREBASE_APP_ID=your_app_id

# Cloudinary Configuration
REACT_APP_CLOUDINARY_CLOUD_NAME=your_cloud_name
REACT_APP_CLOUDINARY_UPLOAD_PRESET=your_upload_preset

# Gemini AI Configuration
REACT_APP_GEMINI_API_KEY=your_gemini_api_key
REACT_APP_AI_MODEL=gemini-flash-latest
```

---

## üî• Firebase Setup

### 1. T·∫°o Firebase Project

1. **Truy c·∫≠p Firebase Console**:
   - V√†o [Firebase Console](https://console.firebase.google.com/)
   - T·∫°o project m·ªõi ho·∫∑c ch·ªçn project hi·ªán c√≥
   - Enable Authentication v√† Firestore Database

2. **L·∫•y Firebase Config**:
   - V√†o Project Settings > General
   - Scroll xu·ªëng "Your apps" > Web app
   - Copy config object v√† paste v√†o file `.env`

### 2. Authentication Setup

1. **V√†o Authentication > Sign-in method**
2. **Enable Email/Password provider**
3. **Optional**: Enable Google, Facebook, etc.

### 3. Firestore Database Setup

1. **V√†o Firestore Database**
2. **T·∫°o database** (ch·ªçn production mode)
3. **Thi·∫øt l·∫≠p security rules**:

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Users can read/write their own data
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Emotion entries - users can only access their own
    match /emotion_entries/{entryId} {
      allow read, write: if request.auth != null && 
        resource.data.userId == request.auth.uid;
    }
    
    // Diary entries - users can only access their own
    match /diary_entries/{entryId} {
      allow read, write: if request.auth != null && 
        resource.data.userId == request.auth.uid;
    }
    
    // Bookings - users can access their own bookings
    match /bookings/{bookingId} {
      allow read, write: if request.auth != null && 
        (resource.data.userId == request.auth.uid || 
         resource.data.psychologistId == request.auth.uid);
    }
    
    // Psychologists - public read access
    match /psychologists/{psychologistId} {
      allow read: if true;
      allow write: if request.auth != null && 
        request.auth.uid == psychologistId;
    }
    
    // Chat messages - users can access their conversations
    match /chat_messages/{messageId} {
      allow read, write: if request.auth != null && 
        (resource.data.senderId == request.auth.uid || 
         resource.data.receiverId == request.auth.uid);
    }
    
    // Conversations - users can access their own conversations
    match /conversations/{conversationId} {
      allow read, write: if request.auth != null && 
        resource.data.userId == request.auth.uid;
    }
  }
}
```

---

## üóÑÔ∏è Firestore Database

### Collections Structure

#### Users Collection
```javascript
users/{userId} {
  id: string,
  email: string,
  name: string,
  role: "admin" | "user" | "psychologist",
  tier?: "free" | "gold",
  avatar?: string,
  goldExpiresAt?: string,
  createdAt: timestamp
}
```

#### Emotion Entries Collection
```javascript
emotion_entries/{entryId} {
  id: string,
  userId: string,
  level: 1 | 2 | 3 | 4 | 5,
  note?: string,
  createdAt: timestamp
}
```

#### Diary Entries Collection
```javascript
diary_entries/{entryId} {
  id: string,
  userId: string,
  title: string,
  content: string,
  mood: 1 | 2 | 3 | 4 | 5,
  createdAt: timestamp
}
```

#### Bookings Collection
```javascript
bookings/{bookingId} {
  id: string,
  userId: string,
  psychologistId: string,
  date: string,
  time: string,
  status: "pending" | "confirmed" | "completed" | "cancelled",
  notes?: string,
  rating?: number,
  ratingComment?: string,
  ratedAt?: timestamp,
  createdAt: timestamp
}
```

#### Psychologists Collection
```javascript
psychologists/{psychologistId} {
  id: string,
  name: string,
  email: string,
  specialization: string,
  experience: number,
  rating: number,
  totalRatings: number,
  avatar: string,
  bio: string,
  available: boolean
}
```

#### Chat Messages Collection
```javascript
chat_messages/{messageId} {
  id: string,
  conversationId: string,
  senderId: string,
  receiverId: string,
  content: string,
  type: "user" | "psychologist",
  createdAt: timestamp,
  read: boolean
}
```

#### Conversations Collection (Gemini AI)
```javascript
conversations/{conversationId} {
  id: string,
  userId: string,
  title: string,
  messages: [
    {
      id: string,
      role: "user" | "assistant",
      content: string,
      timestamp: Date
    }
  ],
  createdAt: timestamp,
  updatedAt: timestamp
}
```

---

## ‚òÅÔ∏è Cloudinary Setup

### 1. T·∫°o t√†i kho·∫£n Cloudinary

1. **Truy c·∫≠p**: https://cloudinary.com
2. **ƒêƒÉng k√Ω** t√†i kho·∫£n mi·ªÖn ph√≠
3. **L·∫•y th√¥ng tin** t·ª´ Dashboard

### 2. C·∫•u h√¨nh Upload Preset

1. **V√†o Cloudinary Dashboard**
2. **Ch·ªçn "Settings" > "Upload"**
3. **Scroll xu·ªëng "Upload presets"**
4. **Click "Add upload preset"**
5. **ƒê·∫∑t t√™n**: `emocare_uploads`
6. **Ch·ªçn "Unsigned"** (kh√¥ng c·∫ßn API key)
7. **Save preset**

### 3. L·∫•y th√¥ng tin t·ª´ Dashboard

- **Cloud Name**: Hi·ªÉn th·ªã ·ªü g√≥c tr√™n Dashboard
- **API Key**: Settings > Security
- **API Secret**: Settings > Security

### 4. C·∫≠p nh·∫≠t .env

```env
REACT_APP_CLOUDINARY_CLOUD_NAME=your_actual_cloud_name
REACT_APP_CLOUDINARY_UPLOAD_PRESET=emocare_uploads
```

### 5. Restart development server

```bash
npm start
```

---

## ü§ñ Gemini AI Setup

### 1. L·∫•y Gemini API Key

1. **Truy c·∫≠p**: [Google AI Studio](https://makersuite.google.com/app/apikey)
2. **ƒêƒÉng nh·∫≠p** v·ªõi Google account
3. **Click "Create API Key"**
4. **Copy API key** v√† paste v√†o file `.env`

### 2. C·∫≠p nh·∫≠t .env

```env
REACT_APP_GEMINI_API_KEY=your_gemini_api_key
REACT_APP_AI_MODEL=gemini-flash-latest
```

### 3. Restart ·ª©ng d·ª•ng

```bash
npm start
```

### 4. C·∫•u h√¨nh AI Model (T√πy ch·ªçn)

C√°c model AI c√≥ s·∫µn:
- `gemini-flash-latest` (M·∫∑c ƒë·ªãnh) - Nhanh nh·∫•t, ph√π h·ª£p cho chat
- `gemini-1.5-flash` - C√¢n b·∫±ng t·ªëc ƒë·ªô v√† ch·∫•t l∆∞·ª£ng
- `gemini-pro` - Ch·∫•t l∆∞·ª£ng cao nh·∫•t, ch·∫≠m h∆°n

Thay ƒë·ªïi model trong file `.env`:
```env
REACT_APP_AI_MODEL=gemini-pro
```

### 5. System Prompts

·ª®ng d·ª•ng s·ª≠ d·ª•ng c√°c system prompts kh√°c nhau t√πy theo context:
- **Main**: T∆∞ v·∫•n t√¢m l√Ω chuy√™n nghi·ªáp
- **Free**: G·ª£i √Ω ƒë·ªãa ƒëi·ªÉm v√† ho·∫°t ƒë·ªông
- **Crisis**: H·ªó tr·ª£ kh·ªßng ho·∫£ng t√¢m l√Ω
- **Wellness**: L·ªùi khuy√™n v·ªÅ l·ªëi s·ªëng l√†nh m·∫°nh

System prompts ƒë∆∞·ª£c t·ª± ƒë·ªông ch·ªçn d·ª±a tr√™n n·ªôi dung tin nh·∫Øn v√† tier ng∆∞·ªùi d√πng.

---

## üìä Firestore Indexes

### L·ªói Index v√† C√°ch Kh·∫Øc Ph·ª•c

#### ‚ùå L·ªói hi·ªán t·∫°i:
```
FirebaseError: The query requires an index. You can create it here: https://console.firebase.google.com/v1/r/project/freelance-bs/firestore/indexes?create_composite=...
```

**L·ªói Conversations Index:**
```
Error getting user conversations: FirebaseError: The query requires an index
```

**L·ªói Gemini API:**
```
POST https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent 404 (Not Found)
```

#### ‚úÖ Gi·∫£i ph√°p:

**C√°ch 1: Code ƒë√£ ƒë∆∞·ª£c t·ªëi ∆∞u (ƒê√£ √°p d·ª•ng)**

Code ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t ƒë·ªÉ:
- ‚úÖ Lo·∫°i b·ªè `orderBy` trong query conversations
- ‚úÖ Sort trong JavaScript thay v√¨ Firestore
- ‚úÖ Th√™m retry logic cho conversation not found
- ‚úÖ Fallback error handling
- ‚úÖ V·∫´n gi·ªØ real-time functionality
- ‚úÖ S·ª≠a Gemini API model name t·ª´ `gemini-1.5-flash-latest` th√†nh `gemini-1.5-flash`
- ‚úÖ S·ª≠ d·ª•ng `systemInstruction` ƒë√∫ng c√°ch cho Gemini API

**C√°ch 2: T·∫°o Index (T√πy ch·ªçn ƒë·ªÉ t·ªëi ∆∞u performance)**

1. **Truy c·∫≠p link t·ª± ƒë·ªông**:
   - Click v√†o link trong error message
   - Firebase s·∫Ω t·ª± ƒë·ªông t·∫°o index c·∫ßn thi·∫øt

2. **T·∫°o manual**:
   - V√†o [Firebase Console](https://console.firebase.google.com/)
   - Ch·ªçn project c·ªßa b·∫°n
   - V√†o **Firestore Database** ‚Üí **Indexes**
   - Click **Create Index**

**C√°c Index c·∫ßn t·∫°o:**

#### 1. Chat Messages - Conversation Index
```json
{
  "collectionGroup": "chat_messages",
  "queryScope": "COLLECTION",
  "fields": [
    {
      "fieldPath": "conversationId",
      "order": "ASCENDING"
    },
    {
      "fieldPath": "createdAt",
      "order": "ASCENDING"
    }
  ]
}
```

#### 2. Chat Messages - Receiver Index
```json
{
  "collectionGroup": "chat_messages",
  "queryScope": "COLLECTION",
  "fields": [
    {
      "fieldPath": "receiverId",
      "order": "ASCENDING"
    },
    {
      "fieldPath": "createdAt",
      "order": "DESCENDING"
    }
  ]
}
```

#### 3. Conversations - User Index
```json
{
  "collectionGroup": "conversations",
  "queryScope": "COLLECTION",
  "fields": [
    {
      "fieldPath": "userId",
      "order": "ASCENDING"
    },
    {
      "fieldPath": "updatedAt",
      "order": "DESCENDING"
    }
  ]
}
```

### üöÄ Sau khi t·∫°o Index:

1. **Index s·∫Ω ƒë∆∞·ª£c build** (c√≥ th·ªÉ m·∫•t v√†i ph√∫t)
2. **Real-time queries s·∫Ω ho·∫°t ƒë·ªông** v·ªõi `orderBy`
3. **Performance s·∫Ω t·ªët h∆°n** cho large datasets

### üí° L∆∞u √Ω:

- **Free tier**: C√≥ gi·ªõi h·∫°n s·ªë index
- **Paid tier**: Kh√¥ng gi·ªõi h·∫°n index
- **Index cost**: M·ªói index t·ªën storage v√† compute
- **Best practice**: Ch·ªâ t·∫°o index khi th·ª±c s·ª± c·∫ßn

### üîß **Code ƒë√£ ƒë∆∞·ª£c t·ªëi ∆∞u:**

#### Conversations Query:
```typescript
// Tr∆∞·ªõc (c·∫ßn index):
const q = query(
  collection(db, 'conversations'),
  where('userId', '==', userId),
  orderBy('updatedAt', 'desc') // ‚Üê C·∫ßn composite index
)

// Sau (kh√¥ng c·∫ßn index):
const q = query(
  collection(db, 'conversations'),
  where('userId', '==', userId) // ‚Üê Ch·ªâ c·∫ßn single field index
)

// Sort trong JavaScript:
conversations.sort((a, b) => b.updatedAt.getTime() - a.updatedAt.getTime())
```

#### Chat Messages Query:
```typescript
// Tr∆∞·ªõc (c·∫ßn index):
const q = query(
  collection(db, 'chat_messages'),
  where('conversationId', '==', conversationId),
  orderBy('createdAt', 'asc') // ‚Üê C·∫ßn index
)

// Sau (kh√¥ng c·∫ßn index):
const q = query(
  collection(db, 'chat_messages'),
  where('conversationId', '==', conversationId) // ‚Üê Ch·ªâ c·∫ßn single field index
)

// Sort trong JavaScript:
messages.sort((a, b) => new Date(a.createdAt).getTime() - new Date(b.createdAt).getTime())
```

#### Retry Logic cho Conversations:
```typescript
// Th√™m retry logic cho conversation not found
let conversation = await this.getConversation(conversationId);
if (!conversation) {
  // Wait a bit and try again (for newly created conversations)
  await new Promise(resolve => setTimeout(resolve, 500));
  conversation = await this.getConversation(conversationId);
}
```

---

## üß™ Testing

### 1. Install dependencies

```bash
npm install
```

### 2. Start development server

```bash
npm start
```

### 3. Test c√°c t√≠nh nƒÉng

#### Authentication:
- ‚úÖ Register a new user
- ‚úÖ Login with existing user
- ‚úÖ Test role-based access
- ‚úÖ Test password reset
- ‚úÖ Test change password

#### Emotion Tracking:
- ‚úÖ Add emotion entry
- ‚úÖ View emotion history
- ‚úÖ Test emotion skip functionality

#### Chatbot AI:
- ‚úÖ Test free tier chatbot
- ‚úÖ Test gold tier Gemini AI
- ‚úÖ Test conversation management
- ‚úÖ Test create/delete conversations

#### Booking System:
- ‚úÖ View psychologists
- ‚úÖ Create booking
- ‚úÖ Manage appointments

#### File Upload:
- ‚úÖ Upload avatar image
- ‚úÖ Test Cloudinary integration

---

## üöÄ Deployment

### Production Build

```bash
npm run build
```

### Environment Variables for Production

ƒê·∫£m b·∫£o t·∫•t c·∫£ bi·∫øn m√¥i tr∆∞·ªùng ƒë∆∞·ª£c c·∫•u h√¨nh ƒë√∫ng trong production environment.

### Firebase Hosting (Optional)

```bash
npm install -g firebase-tools
firebase login
firebase init hosting
firebase deploy
```

---

## üîß Troubleshooting

### Common Issues:

1. **Firebase connection error**:
   - Ki·ªÉm tra API key trong `.env`
   - ƒê·∫£m b·∫£o project ID ƒë√∫ng

2. **Cloudinary upload fails**:
   - Ki·ªÉm tra Cloud Name v√† Upload Preset
   - ƒê·∫£m b·∫£o preset ƒë∆∞·ª£c set l√† "Unsigned"

3. **Gemini API error**:
   - Ki·ªÉm tra API key c√≥ quy·ªÅn truy c·∫≠p Gemini
   - Ki·ªÉm tra quota v√† billing

4. **Firestore index error**:
   - T·∫°o index theo h∆∞·ªõng d·∫´n tr√™n
   - Ho·∫∑c s·ª≠ d·ª•ng code ƒë√£ t·ªëi ∆∞u (kh√¥ng c·∫ßn index)

### Support:

N·∫øu c√≥ v·∫•n ƒë·ªÅ, vui l√≤ng t·∫°o issue tr√™n GitHub repository v·ªõi:
- Error message ƒë·∫ßy ƒë·ªß
- Steps to reproduce
- Environment details

---

**EmoCare** - ChƒÉm s√≥c s·ª©c kh·ªèe t√¢m l√Ω c·ªßa b·∫°n m·ªôt c√°ch to√†n di·ªán v√† hi·ªán ƒë·∫°i üíö
